#!/usr/bin/env bash
TARGET="https://www.linuxfromscratch.org/blfs/view/svn/"
OUTFILE="/var/cache/scratchpkg/workbook/blfs-categorized.txt"
unwanted='appendices|introduction|legalnotice|mit|preface'

tmpfile=$(mktemp)

# Step 1: Get list of category names
categories=$(curl -s "$TARGET" | grep -Eo 'href="[^"]+/"' | sed -e 's/href="//;s/"$//' | grep -viE "$unwanted")

# Step 2: For each category, fetch the category index HTML (category/category.html)
for category in $categories; do
  catpage="${category%/}/${category%/}.html"
  curl -s "$TARGET$catpage" | \
    grep -Eo 'href="[^"]+\.html"' | \
    sed -e 's/href="//;s/"$//' | \
    grep -vE '(^|/)(longindex|download|index|'"$category"')\.html$' | \
    grep -viE "$unwanted" | \
    while read -r href; do
      catname=$(echo "$href" | cut -d/ -f1)
      pkg=$(basename "$href" .html)
      [[ -n "$catname" && -n "$pkg" ]] && echo "$catname:$pkg"
    done
done | sort -t: -k1,1 -k2,2 > "$tmpfile"

# Step 3: Format output
{
  lastcat=""
  while IFS=":" read -r category pkg; do
    if [[ "$category" != "$lastcat" ]]; then
      printf "\n%s:\n" "$category"
      lastcat=$category
    fi
    printf "  - %s\n" "$pkg"
  done < "$tmpfile"
} > "$OUTFILE"

echo "Done â†’ $OUTFILE"
